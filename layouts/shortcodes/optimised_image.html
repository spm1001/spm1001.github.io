{{/*
  Shortcode for responsive, optimized images.
  Usage: {{< optimised_image src="image.jpg" alt="Description" caption="Optional caption." >}}
  Place images in the same folder as your index.md.
*/}}
{{- $src := .Get "src" | MANDATORY_PARAMETER "The 'src' attribute is required." -}}
{{- $alt := .Get "alt" | MANDATORY_PARAMETER "The 'alt' attribute is required for accessibility." -}}
{{- $caption := .Get "caption" -}}
{{- $width := .Get "width" | default "700" -}}

{{- with $src -}}
  {{- $imageResource := $.Page.Resources.GetMatch . -}}
  {{- if not $imageResource -}}
    {{- errorf "Image not found: '%s' in page '%s'. Make sure the image is in the same folder as your index.md." . $.Page.Path -}}
  {{- end -}}

  {{/* Generate the optimized images */}}
  {{- $webp := $imageResource.Resize (printf "%sx webp" $width) -}}
  {{- $fallback := $imageResource.Resize (printf "%sx" $width) -}}

  <figure>
    <picture>
      <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
      <source srcset="{{ $fallback.RelPermalink }}" type="{{ $fallback.MediaType }}">
      <img src="{{ $fallback.RelPermalink }}" 
           alt="{{ $alt }}" 
           width="{{ $fallback.Width }}" 
           height="{{ $fallback.Height }}"
           loading="lazy">
    </picture>
    {{- with $caption -}}
      <figcaption>{{ . | markdownify }}</figcaption>
    {{- end -}}
  </figure>
{{- end -}}
