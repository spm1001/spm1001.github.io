{{/*
  Shortcode for responsive, optimized images.
  Usage: {{< optimised_image src="image.jpg" alt="Description" caption="Optional caption." >}}
  Place images in the same folder as your index.md.
*/}}
{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" -}}
{{- $caption := .Get "caption" -}}
{{- $width := .Get "width" | default "700" -}}

{{- if not $src -}}
  {{- errorf "The 'src' attribute is required for the optimised_image shortcode." -}}
{{- end -}}

{{- if not $alt -}}
  {{- errorf "The 'alt' attribute is required for accessibility in the optimised_image shortcode." -}}
{{- end -}}

{{- $imageResource := "" -}}
{{- if hasPrefix $src "http" -}}
  {{- $imageResource = resources.GetRemote $src -}}
{{- else -}}
  {{- $imageResource = $.Page.Resources.GetMatch $src -}}
{{- end -}}

{{- if not $imageResource -}}
  {{- errorf "Image not found: '%s' in page '%s'. Make sure local images are in the same folder as your index.md." $src $.Page.Path -}}
{{- end -}}

{{/* Generate the optimized images */}}
{{- $webp := $imageResource.Resize (printf "%sx webp" $width) -}}
{{- $fallback := $imageResource.Resize (printf "%sx" $width) -}}

<figure>
  <picture>
    <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
    <source srcset="{{ $fallback.RelPermalink }}" type="{{ $fallback.MediaType }}">
    <img src="{{ $fallback.RelPermalink }}" 
         alt="{{ $alt }}" 
         width="{{ $fallback.Width }}" 
         height="{{ $fallback.Height }}"
         loading="lazy">
  </picture>
  {{- with $caption -}}
    <figcaption>{{ . | markdownify }}</figcaption>
  {{- end -}}
</figure>
